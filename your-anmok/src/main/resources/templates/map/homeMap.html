<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Kakao 지도 시작하기</title>
    <style>
        /*.map_wrap {position:relative;width:100%;height:500px;}*/
        #my_location_button{position: absolute;bottom:0;right:0;z-index: 100}
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0faeb3dc4793a50259747d85fd7d9a89&libraries=services"></script>

    <style>
        #popup_layer {position:fixed;top:0;left:0;z-index: 10000; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4);display:none;}
        /*팝업 박스*/
        #popup_box{border-radius:10px;position: relative;top:50%;left:50%; width:1120px;height:630px;transform:translate(-50%, -50%);z-index:1002;box-sizing:border-box;background:#fff;box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);-webkit-box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);-moz-box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);}
        /*팝업 닫기 버튼*/
        #close{width:20px;height:20px;position:absolute;top:50%;transform:translate(0, -50%);right:35px;}
        .usr_img{width:280px;height:210px;background-color:#afafaf}
        .next_btn_img, .prev_btn_img{position:absolute;vertical-align:middle;width:30px;height:30px;top:50%;left:50%;transform:translate(-50%, -50%);}
        .inner_contents_box{width:445px;height:117px;background-color:#e8f8f5;}
    </style>

</head>

<body>
<div class="map_wrap" style="position: relative;">
    <div id="map" class="w-screen h-screen" >

    </div>
    <button id="my_location_button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="getCurrentPosBtn()">
        마이로케이션버튼
    </button>
    <div id="search_wrap" class="bg_white" style="position: absolute; top:0; right: 0; z-index: 90;">
        <div class="option">
            <div>
                <form onsubmit="searchPlaces(); return false;">
                    키워드 : <input type="text" value="해운대 맛집" id="keyword" size="15" />
                    <button type="submit">검색하기</button>
                </form>
            </div>
        </div>
        <hr>
        <ul id="placeList" style="position: absolute; top: 30px; right: 0; z-index: 90;"></ul>
        <div id="pagination" style="position: absolute; top: 30px; right: 0; z-index: 90;"></div>
    </div>
</div>

<script
        type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0faeb3dc4793a50259747d85fd7d9a89"
></script>

<script>
    let container = document.getElementById("map");
    let options = {
        // 일단 홍대를 중심으로 잡는 맵 생성
        center: new kakao.maps.LatLng(37.55698559918365, 126.92444391816313),
        // // 일단 적당한 지도의 높이 레벨 5 정도로 잡았슴다
        level: 5,
    };

    let map = new kakao.maps.Map(container, options);

    // markerPosition(포지션)을 Latlng로 포지션화(좌표화) -> 스타벅스 홍대점 좌표 구해서 넣었습니다.
    let starbucksHondaeMarkerPosition = new kakao.maps.LatLng(37.55751541928109, 126.92520449490704);

    // starbucksHondaeMarker 생성자
    let starbucksHondaeMarker = new kakao.maps.Marker({
        position: starbucksHondaeMarkerPosition,
        clickable: true
    })

    // starbucksHongdaeMarker를 지도 위에 표시 -> setMap
    starbucksHondaeMarker.setMap(map);

    //starbucksHondaeMarker로 명칭 변경했습니다..
    // let marker = new kakao.maps.Marker({
    //     position: markerPosition,
    //     clickable:true
    //
    // });

    function locationLoadSuccess(pos) {
        let currentPos = new kakao.maps.LatLng(
            pos.coords.latitude,
            pos.coords.longitude
        );

        map.panTo(currentPos);

        let marker = new kakao.maps.Marker({
            position: currentPos,
        });

        marker.setMap(null);
        marker.setMap(map);
    }

    function getCurrentPosBtn() {
        navigator.geolocation.getCurrentPosition(locationLoadSuccess, null);
        console.log("현재위치 버튼 클릭됨");
    }

    kakao.maps.event.addListener(starbucksHondaeMarker, 'click', function (){
        document.getElementById("popup_layer").style.display='block'
        console.log("스타벅스 클릭");
    });

    function closePopup(){
        document.getElementById("popup_layer").style.display="none"
    };

    // 마커 클릭시 장소명 표출하는 인포윈도우
    let infowindow = new kakao.maps.InfoWindow({zIndex:1});

    // 장소 검색 객체를 생성
    let ps = new kakao.maps.services.Places();

    // ------------------------ 키워드 검색 ----------

    // 키워드로 장소를 검색
    // let markers = [];

    // searchPlaces();
    //

    function searchPlaces(){
        // input에 들어가는 키워드의 value값이 keyword
        let keyword = document.getElementById('keyword').value;

        // keyword가 공백이면 alert 뜨도록
        if(!keyword.replace(/^s+|\s+$/g,'')){
            alert('키워드를 입력해주세요!');
            return false;
            // 잘 작동중
        }

        // 하.. kerword는 뭡니까?
        ps.keywordSearch(keyword, placesSearchCB); // keyword = 해운대맛집 => keywordSearch("해운대맛집",placeSearchCB);
    }

    // 키워드로 검색 완료시 호출되는 콜백함수
    function placesSearchCB (data, status, pagination){
        // 여기가 안 들어오네.. 왜 안 들어올까.. 오타 고치니까 들어옴 ㅎㅎ
        console.log("placeSearhCB들어옴")
        if(status === kakao.maps.services.Status.OK){
            console.log("placeSearchCB status 일치");
            // 검색된 장소 위치를 기준으로 지도 범위 재설정하기 위해
            // LatLngBounds 객체에 좌표를 추가한다.

            displaySearchListPlaces(data);

            // boundss와 data 개수에 따라 마커 표시하고 bound에 추가하는 코드는
            // SearchListPlaces 함수로 넣어서 관리
            // let bounds = new kakao.maps.LatLngBounds();

            // for(let i=0; i<data.length;i++){
            //     displayMarker(data[i]);
            //     bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
            // }

            //  검색된 장소 위치를 기준으로 지도 범위를 재설정 -> setBounds
            // map.setBounds(bounds);
        }
    }

    // 지도에 마커를 표시하는 함수인 displayMarker
    function displayMarker(place){
        // 마커 생성
        let placeMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x)
        });

        kakao.maps.event.addListener(placeMarker,'click',function(){
            infowindow.setContent('<div style="padding:5px; font-size:12px;">'+place.place_name+'</div>')
            infowindow.open(map, placeMarker);
        });
    }

    function displaySearchListPlaces(places){
        let listEl = document.getElementById('placeList'),
            menuEl = document.getElementById('search_wrap'),
            fragment = document.createDocumentFragment(),
            bounds = new kakao.maps.LatLngBounds();
        // 아 진짜 오타 왜이리 많이 냄? 정신 안 차림?

        for (let i=0;i<places.length;i++){
            let itemE1 = getListItem(i, places[i]);

            displayMarker(places[i]);
            bounds.extend(new kakao.maps.LatLng(places[i].y, places[i].x));

            fragment.appendChild(itemE1);
            console.log("반복문 도는지 확인");
        }

        console.log(fragment);
        listEl.appendChild(fragment);
        console.log(listEl);
        map.setBounds(bounds);
    }

    function getListItem(index, places){
        let el = document.createElement('li'),

        itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
            '<div class="info">' +
            '   <h5>' + places.place_name + '</h5>';

        // if (places.road_address_name) {
        //     itemStr += '    <span>' + places.road_address_name + '</span>' +
        //         '   <span class="jibun gray">' +  places.address_name  + '</span>';
        // } else {
        //     itemStr += '    <span>' +  places.address_name  + '</span>';
        // }
        //
        // itemStr += '  <span class="tel">' + places.phone  + '</span>' +
        //     '</div>';

        el.innerHTML = itemStr;
        el.className = 'item';

        return el;
    }

</script>
<!--팝업창 레이아웃 html-->
<div id="popup_layer">
    <div id="popup_box">
        <!--팝업 컨텐츠 영역-->
        <div id="popup_contents ">
            <th:block th:replace="popup/popup :: contentsTop"></th:block>
            <th:block th:replace="popup/popup :: contentsMiddle"></th:block>
            <th:block th:replace="popup/popup :: contentsBottom"></th:block>
        </div>
    </div>
</div>

</body>
</html>
<!--git remote update  -> git checkout 해당 브랜치 -> git merge  -->
<!-- -->